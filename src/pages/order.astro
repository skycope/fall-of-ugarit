---
import '../styles/global.css';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order | The Fall of Ugarit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Joanna';
      src: url('/fonts/joanna-regular.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Joanna', 'Joanna MT', 'EB Garamond', Georgia, serif;
      background: #10265f;
      color: #fff;
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 3rem 1.5rem;
    }

    .back-link {
      color: rgba(255,255,255,0.6);
      text-decoration: none;
      font-size: 0.9rem;
      display: inline-block;
      margin-bottom: 2rem;
    }

    .back-link:hover {
      color: #ffb102;
    }

    h1 {
      font-family: 'Joanna', 'Joanna MT', 'Crimson Text', Georgia, serif;
      font-size: 2rem;
      color: #ffb102;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: rgba(255,255,255,0.7);
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    label {
      display: block;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.8);
      margin-bottom: 0.4rem;
    }

    input, select {
      width: 100%;
      padding: 0.7rem 0.9rem;
      font-family: inherit;
      font-size: 1rem;
      background: #1a3470;
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 4px;
      color: #fff;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #ffb102;
      background: #1e3d7a;
    }

    input::placeholder {
      color: rgba(255,255,255,0.4);
    }

    select {
      cursor: pointer;
    }

    select option {
      background: #1a3470;
      color: #fff;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin: 1.5rem 0;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      accent-color: #ffb102;
    }

    .checkbox-group label {
      margin: 0;
      cursor: pointer;
    }

    .collection-info {
      background: rgba(255,177,2,0.1);
      border: 1px solid rgba(255,177,2,0.3);
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .collection-info h3 {
      font-size: 0.9rem;
      color: #ffb102;
      margin-bottom: 0.3rem;
    }

    .collection-info p {
      font-size: 0.95rem;
      color: rgba(255,255,255,0.8);
      margin: 0;
    }

    .address-fields {
      display: none;
      padding: 1rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      margin-bottom: 1.25rem;
    }

    .address-fields.visible {
      display: block;
    }

    .address-fields h3 {
      font-size: 1rem;
      color: #ffb102;
      margin-bottom: 1rem;
    }

    .summary {
      background: rgba(255,177,2,0.1);
      border: 1px solid rgba(255,177,2,0.3);
      border-radius: 6px;
      padding: 1.25rem;
      margin: 1.5rem 0;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.3rem 0;
      color: rgba(255,255,255,0.8);
    }

    .summary-row.total {
      border-top: 1px solid rgba(255,255,255,0.2);
      margin-top: 0.5rem;
      padding-top: 0.75rem;
      font-size: 1.2rem;
      color: #ffb102;
    }

    button[type="submit"] {
      width: 100%;
      padding: 1rem;
      background: #ffb102;
      color: #10265f;
      font-family: 'Joanna', 'Joanna MT', 'Crimson Text', Georgia, serif;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button[type="submit"]:hover {
      background: #ffc942;
    }

    button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error {
      background: rgba(220,38,38,0.2);
      border: 1px solid rgba(220,38,38,0.4);
      color: #fca5a5;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      display: none;
    }

    .error.visible {
      display: block;
    }

    .note {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.5);
      margin-top: 1rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">← Back to book</a>

    <h1>Order</h1>
    <p class="subtitle">The Fall of Ugarit by Michael Cope</p>

    <div id="error" class="error"></div>

    <form id="orderForm">
      <div class="form-group">
        <label for="name">Full Name</label>
        <input type="text" id="name" name="name" required placeholder="Your name">
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required placeholder="you@example.com">
      </div>

      <div class="form-group">
        <label for="phone">Phone</label>
        <input type="tel" id="phone" name="phone" required placeholder="082 123 4567">
      </div>

      <div class="form-group">
        <label for="quantity">Quantity</label>
        <select id="quantity" name="quantity">
          <option value="1">1 book</option>
          <option value="2">2 books</option>
          <option value="3">3 books</option>
          <option value="4">4 books</option>
          <option value="5">5 books</option>
        </select>
      </div>

      <div class="collection-info">
        <h3>Collection</h3>
        <p>5 St. Helier's Road, Muizenberg, 7945, Cape Town</p>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="delivery" name="delivery">
        <label for="delivery">Deliver to me instead (+R100, South Africa only)</label>
      </div>

      <div id="addressFields" class="address-fields">
        <h3>Delivery Address</h3>
        <div class="form-group">
          <label for="street">Street Address</label>
          <input type="text" id="street" name="street" placeholder="123 Main Road">
        </div>
        <div class="form-group">
          <label for="suburb">Suburb (optional)</label>
          <input type="text" id="suburb" name="suburb" placeholder="Gardens">
        </div>
        <div class="form-group">
          <label for="city">City</label>
          <input type="text" id="city" name="city" placeholder="Cape Town">
        </div>
        <div class="form-group">
          <label for="postalCode">Postal Code</label>
          <input type="text" id="postalCode" name="postalCode" placeholder="8001">
        </div>
      </div>

      <div class="summary">
        <div class="summary-row">
          <span>Books (<span id="summaryQty">1</span> × R400)</span>
          <span>R<span id="summaryBooks">400</span></span>
        </div>
        <div class="summary-row" id="deliveryRow" style="display: none;">
          <span>Delivery</span>
          <span>R100</span>
        </div>
        <div class="summary-row total">
          <span>Total</span>
          <span>R<span id="summaryTotal">400</span></span>
        </div>
      </div>

      <button type="submit" id="submitBtn">Proceed to Payment</button>
    </form>

    <p class="note">You'll be redirected to Yoco to complete payment securely.</p>
  </div>

  <script>
    const form = document.getElementById('orderForm');
    const quantitySelect = document.getElementById('quantity');
    const deliveryCheckbox = document.getElementById('delivery');
    const addressFields = document.getElementById('addressFields');
    const errorDiv = document.getElementById('error');
    const submitBtn = document.getElementById('submitBtn');

    const summaryQty = document.getElementById('summaryQty');
    const summaryBooks = document.getElementById('summaryBooks');
    const summaryTotal = document.getElementById('summaryTotal');
    const deliveryRow = document.getElementById('deliveryRow');

    const BOOK_PRICE = 400;
    const DELIVERY_FEE = 100;

    function updateSummary() {
      const qty = parseInt(quantitySelect.value);
      const delivery = deliveryCheckbox.checked;

      const booksTotal = qty * BOOK_PRICE;
      const total = booksTotal + (delivery ? DELIVERY_FEE : 0);

      summaryQty.textContent = qty;
      summaryBooks.textContent = booksTotal;
      summaryTotal.textContent = total;
      deliveryRow.style.display = delivery ? 'flex' : 'none';
    }

    quantitySelect.addEventListener('change', updateSummary);
    deliveryCheckbox.addEventListener('change', () => {
      addressFields.classList.toggle('visible', deliveryCheckbox.checked);
      updateSummary();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.classList.remove('visible');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      const formData = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        quantity: parseInt(quantitySelect.value),
        delivery: deliveryCheckbox.checked,
        address: deliveryCheckbox.checked ? {
          street: document.getElementById('street').value,
          suburb: document.getElementById('suburb').value,
          city: document.getElementById('city').value,
          postalCode: document.getElementById('postalCode').value
        } : null
      };

      try {
        const response = await fetch('/api/create-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Something went wrong');
        }

        // Redirect to Yoco payment page
        window.location.href = data.checkoutUrl;

      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.add('visible');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Proceed to Payment';
      }
    });

    // Check for cancelled/failed status
    if (window.location.hash === '#cancelled') {
      errorDiv.textContent = 'Payment was cancelled. Please try again.';
      errorDiv.classList.add('visible');
    } else if (window.location.hash === '#failed') {
      errorDiv.textContent = 'Payment failed. Please try again or contact us.';
      errorDiv.classList.add('visible');
    }
  </script>
</body>
</html>
